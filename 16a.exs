input =
  ~S(\..\/|../.-..-....................................|.-..-.......|...--........-......\...\........\............
..\...|.\.........|..|.....................|.....\.........................................-.......|-..../....
......\\\........\............-........\............/.....-|..............|....................\....-.........
................................-..\-.........\.-....-.............................|........\...............\.
................\/..........\................/...........................|./......|...........|...............
......../....|..-........|./..../......................../............./-/....-.....................\.........
../..|/.|.............\..\\.............../...................../..............|....................-.........
...........................\..\......./................/....\......................-........|................/
..........|../.....|./........-.\......../.................../........................|..../......|...........
.........../...../....................-....|.-..........-.........\../..\...\../..|../........|.....\.........
.../........\/....../.......................-......................-|..../.../...-.......-.../................
..........|.....-.././.....|../.\.....................-.......................................-....|.|...|....
............./...-...................|.-...|.-........-.......|..............|......-.........................
........\\..\.................\........-............/|......-.......|........................./.......|.....\.
....|..../..\........................./....|/......../.......-..........|/..........................-.........
.............\...............................................\......\........./.....-..../..\......-...-.....|
.........../.................../...........-......../|.............../.................\../...\...............
................/-.......-......................./....................................-..................|...\
......................................|..................-....\...............|.../.........|..|..|...../.-...
.\......-./..-....\.....\............./...-......\........................-./..//.......-........|............
......|...-...\........|........|........./.....\|.....................\........\.........-....\.....|....|...
....................|.............................-..........................|..........-..../........|.-.....
.-.-.....................|........./.....\........./....\|/..\...........\......./...-.............\.|.../...\
............/...................................................../../................./.-....................
................../.........\.|........./............|........|...............................................
.\............/.-..-......|.....|....-........\..............................|....-.|.........|......./......\
....|..................................-..-......-.............-..-/..........................-........|../...
-..|-.../................-...............|.......-\.........-....../.\..............///....\............../...
.........../......................|........-....-...|....|...-...|......|.................../........-........
........|.........../...............\......................|..-.-.....................|.........-.............
./............/..\......\.....|..\...|........................-.../.......//...|..............\..../\.........
.-...|.-...............\......../.|.../............|.........|../|....././......./........||.\...-............
................-........-/.............../.....-.\/......................../....................\............
....\............./..../.........................-.............\...\.../........../................-/...-...|.
......................................|......./.-....../...................../.....|..........................
.|..................\..........\....-.......-......\..|.-.................-...\.............|......../........
..|...........|./.................\.........................|.........................-\......................
../.../.........../.......-.......-/............./..............\........-..........-..|...\.\/.-..|..........
............./..............-\../..|..\.....................................\............-........-.........|.
.....|-.................|............|/...............................\............/...\.........\............
........\.....\.....\...........\..........-...........................\.......-.......................\../...
........./........|..............................-......\.........................|..|.-.....|....../.........
............-.......\............/...\./.............../\.\..............|............\.../............\......
...../.....\..............|...............................................-......................./...........
...../........|.....................-.....................|.../.....................\.../...../..............\
..........|.........-....................-\............-.....................-...................\..../.......
.............\.........|\..........................\........-.....|.\..............|.......-..\..............\
............./\..\\............|...-/..........-...................//.\.......\................../..........|.
........................|.|.....|......\...-.-...\.......|...|...........\.-.............|......|............|
.....|......|.......\.........\................\\......|......................\.............\..\..............
......................|....../.........|........./.......-...\..............\...||......../..................|
....|..\.-.................|....\.............../.....-......../......................../....../..........|...
./.......|............././../.-...-...........\\..|...\......................../........|....-.\..............
........................|.......|......................-...../....................................../.\.......
....\..-.....|......................\...............|...|\.......|....../......|....\.-../.............../....
....../........-\...|.............|.......................\..................-.........\.......-.....-.....-./
.......|....\.............|.......|....\.../........................|.........................................
.....|.........\.../....-......./......\.........................../................-.................\.......
..|../.../.|.....-../...../..........-....../.\......../........../..................\.....\...-...-...\..|...
..|...........\.\.........\.....-.............-............../...|........./..........\-......................
..../...\............\..........-...../.................................................../......-..|........-
..............\............|................./.\........|.......................|.........\/....-.............
......................-.............\|...|............../........\|../......../........./.\.../\.............|
...........\.....................................\.../.............................|..............-../........
................./...................\......../............................-....\.................\.-.|\......
....-../................|.......\.-.........|...\.|.........\...........\...|.................././.....\......
..-....-....../...-...\/...............\.......\.........................|..|..../.....................\......
/........\......../..............|..............|...|............|...............\............-.|.............
...\./............/....../......--.......-............-..\........\..................\.......\-............./.
-..\-..//......-.............\....\-.|........-|......................./................................../...
...........\......-.........................-.\|...|...........-.....\.......-........|.|.--..|........./.....
.......-........................./............|.............|................./..................-.......|-|./
.......|..........-................../.......................................|..../.......................|...
.....-........../.-../........./\..../.....\...-.....-...............|...../.../.....................\........
.........................|........|\../.../......|.................\..............-|....../..|................
...\...\.....................|.....|....\............|...|...../...|\............-.-........................-.
....................\|..............\...../........../..../........................-..........-...........\...
...\.........................|........-......................./..../................................./........
|......................./.../............../...\....................-.........................-........../|...
.......-../......../....\...................../........................./......\\......\.........\......../...
...-.....-......../..-/........\...............................\..........-.....................|........-....
..-....|............/.|-.........-..............................\.........-.........-....................//-..
...-\......-../..../...|-............................................\...............\...\...\..|\......|.....
......../...........-............................-...........................................\.....\.../......
........................\.......\...\......|.....\..\.-\.............../.......--...../|\.............|/......
.............../...............|....\......-.....|\..................|....-.................-......-........\.
\.......................-........-......|.................................|..-....-................./.........
.........|............\.........../..\......-.................\...\........./|.|.-.........\............./....
.-.........|................................/\......./..........|......................../........\...........
......................................\\...................../........................-\........../.-.......-.
......\....................................../.............................|.../.................\............
........-...|..-...\...\...........-.............-......................../................\..................
...../....../.......................\................/....\.-..-..../........|.......-........................
.........|.....|.......\/..............|....-.-../|\.......\../..........\....\./....-.....|..../.../.........
........\...../......|.................................-...........................-.-.....|............|../..
-../.............\.....|..\......|.../........................./...-...../............../\-.........-.........
...........\.........-....................-.....\...............-.................\...-.../.......\...........
./........................\................-..../.\........./......-....|.............../.-.........../......\
....................-.............\.......\-................|................-.......................|..|.....
.......\.../.....|./..\..........-.........../.......|.................-..................|.|................/
.....\....|.................\.-./........|.........\..-.........\....\.......|...\....-...............-.......
......................................-...........-|..|.../..\...\.\../.................-|......\.....-.......
......|........|......................|....././....././........./......................-./...\................
..........\........|.....\......\......................|......./....................../.\............-.....|..
|.....-............./........|...\../.......|......../\.|.-......\.\........|....\............./..........\...
-.......................|..|/...........-.......-.....-............-........................./................
.......|....-......................\..........................-...|...........................................
\......\........|.\..\.............\-..............\./......................-.....|...../..|..-.............|.
......-.............................../......-........-|............-..........-.....\//.-/.....\..........-\.
...............................|.........|/.../................................................|..............)

matrix = String.split(input, "\n") |> Enum.map(&String.split(&1, "", trim: true))

defmodule BFS do
  def search(_matrix, queue, visited) when length(queue) == 0 do
    visited
  end

  def search(matrix, queue, visited) do
    [curr_beam | rest] = queue
    {curr_x, curr_y, curr_dir} = curr_beam

    if curr_x < 0 || curr_x >= length(matrix) || curr_y < 0 ||
         curr_y >= length(Enum.at(matrix, 0)) || curr_beam in visited do
      search(matrix, rest, visited)
    else
      next_visited = [curr_beam | visited]
      # IO.inspect([matrix, curr_x, curr_y])
      curr_char = matrix |> Enum.at(curr_x) |> Enum.at(curr_y)

      next_dirs =
        case {curr_char, curr_dir} do
          {".", _} ->
            [curr_dir]

          {"/", :up} ->
            [:right]

          {"/", :right} ->
            [:up]

          {"/", :down} ->
            [:left]

          {"/", :left} ->
            [:down]

          {"\\", :up} ->
            [:left]

          {"\\", :right} ->
            [:down]

          {"\\", :down} ->
            [:right]

          {"\\", :left} ->
            [:up]

          {"|", :up} ->
            [:up]

          {"|", :right} ->
            [:up, :down]

          {"|", :down} ->
            [:down]

          {"|", :left} ->
            [:up, :down]

          {"-", :up} ->
            [:left, :right]

          {"-", :right} ->
            [:right]

          {"-", :down} ->
            [:left, :right]

          {"-", :left} ->
            [:left]
        end

      next_beams =
        next_dirs
        |> Enum.map(fn dir ->
          case dir do
            :up -> {curr_x - 1, curr_y, dir}
            :right -> {curr_x, curr_y + 1, dir}
            :down -> {curr_x + 1, curr_y, dir}
            :left -> {curr_x, curr_y - 1, dir}
          end
        end)

      search(matrix, rest ++ next_beams, next_visited)
    end
  end
end

ans =
  BFS.search(matrix, [{0, 0, :right}], [])
  |> Enum.uniq_by(fn {x, y, _dir} -> {x, y} end)
  |> Enum.count()

IO.inspect(ans)
# 7496
